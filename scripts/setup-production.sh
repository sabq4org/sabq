#!/bin/bash

# ุณูุฑูุจุช ุฅุนุฏุงุฏ ุงูุจูุฆุฉ ููุฅูุชุงุฌ
# ูุณุชุฎุฏู ุนูู ุงูุณูุฑูุฑ ูุถูุงู ุงูุฅุนุฏุงุฏุงุช ุงูุตุญูุญุฉ

echo "๐ ุฅุนุฏุงุฏ ุงูุจูุฆุฉ ููุฅูุชุงุฌ..."

# ุงูุชุญูู ูู ูุฌูุฏ ุงููุชุบูุฑุงุช ุงููุทููุจุฉ
check_env_var() {
    if [ -z "${!1}" ]; then
        echo "โ ุฎุทุฃ: ุงููุชุบูุฑ $1 ุบูุฑ ููุฌูุฏ!"
        return 1
    else
        echo "โ $1 ููุฌูุฏ"
        return 0
    fi
}

echo ""
echo "๐ ุงูุชุญูู ูู ูุชุบูุฑุงุช ุงูุจูุฆุฉ ุงููุทููุจุฉ..."
echo "========================================="

# ุงููุชุบูุฑุงุช ุงูุฃุณุงุณูุฉ
REQUIRED_VARS=(
    "DATABASE_URL"
    "JWT_SECRET"
    "NEXT_PUBLIC_API_URL"
    "NEXT_PUBLIC_SITE_URL"
)

# ุงููุชุบูุฑุงุช ุงูุงุฎุชูุงุฑูุฉ
OPTIONAL_VARS=(
    "OPENAI_API_KEY"
    "CLOUDINARY_CLOUD_NAME"
    "CLOUDINARY_API_KEY"
    "CLOUDINARY_API_SECRET"
    "SMTP_HOST"
    "SMTP_USER"
    "SMTP_PASS"
)

# ุงูุชุญูู ูู ุงููุชุบูุฑุงุช ุงููุทููุจุฉ
ALL_GOOD=true
for var in "${REQUIRED_VARS[@]}"; do
    if ! check_env_var "$var"; then
        ALL_GOOD=false
    fi
done

# ุงูุชุญูู ูู ุงููุชุบูุฑุงุช ุงูุงุฎุชูุงุฑูุฉ
echo ""
echo "๐ ุงูุชุญูู ูู ุงููุชุบูุฑุงุช ุงูุงุฎุชูุงุฑูุฉ..."
echo "========================================="
for var in "${OPTIONAL_VARS[@]}"; do
    check_env_var "$var" || true
done

if [ "$ALL_GOOD" = false ]; then
    echo ""
    echo "โ ุจุนุถ ุงููุชุบูุฑุงุช ุงููุทููุจุฉ ููููุฏุฉ!"
    echo "ูุฑุฌู ุฅุถุงูุชูุง ูู ููุญุฉ ุชุญูู ุงูุณูุฑูุฑ"
    exit 1
fi

echo ""
echo "๐ง ุชูููุฏ Prisma Client..."
echo "========================================="
npx prisma generate

echo ""
echo "๐ ุงุฎุชุจุงุฑ ุงูุงุชุตุงู ุจูุงุนุฏุฉ ุงูุจูุงูุงุช..."
echo "========================================="
node scripts/test-database-connection.js

if [ $? -ne 0 ]; then
    echo "โ ูุดู ุงุฎุชุจุงุฑ ูุงุนุฏุฉ ุงูุจูุงูุงุช!"
    exit 1
fi

echo ""
echo "๐๏ธ ุจูุงุก ุงููุดุฑูุน..."
echo "========================================="
npm run build

if [ $? -ne 0 ]; then
    echo "โ ูุดู ุจูุงุก ุงููุดุฑูุน!"
    exit 1
fi

echo ""
echo "โ ุชู ุฅุนุฏุงุฏ ุงูุจูุฆุฉ ุจูุฌุงุญ!"
echo ""
echo "๐ ููุงุญุธุงุช ูููุฉ:"
echo "1. ุชุฃูุฏ ูู ุฃู DATABASE_URL ูุญุชูู ุนูู ?sslmode=require"
echo "2. ุชุฃูุฏ ูู ุฃู JWT_SECRET ููู ูุขูู"
echo "3. ุชุฃูุฏ ูู ุฃู NEXT_PUBLIC_API_URL ูุดูุฑ ุฅูู ุงููุทุงู ุงูุตุญูุญ"
echo ""
echo "๐ ููููู ุงูุขู ุชุดุบูู ุงููุดุฑูุน ุจุงุณุชุฎุฏุงู: npm start" 