# 🔧 دليل إصلاح مشاكل المصادقة على DigitalOcean

## 📋 المشاكل المكتشفة

### ❌ الأخطاء الحالية:
- `401 Unauthorized` على `/api/auth/me`
- `500 Internal Server Error` على `/api/auth/login`
- مشاكل في الاتصال بقاعدة البيانات
- مشاكل في إعدادات JWT

## 🛠️ الحلول المطبقة

### 1️⃣ تحسين API Routes للمصادقة

#### ✅ `/api/auth/login` - تم تحسينه:
- إضافة فحص شامل لمتغيرات البيئة
- معالجة أفضل لأخطاء قاعدة البيانات
- تحسين إدارة اتصالات Prisma
- إضافة رموز أخطاء واضحة
- تحسين إعدادات الكوكيز

#### ✅ `/api/auth/me` - تم تحسينه:
- فصل استعلامات قاعدة البيانات لتجنب أخطاء العلاقات
- معالجة أفضل للأخطاء
- إضافة fallback للبيانات المفقودة
- تحسين إدارة الاتصالات

### 2️⃣ سكريبت الإصلاح التلقائي

تم إنشاء `scripts/fix-digitalocean-auth.js` الذي يقوم بـ:
- فحص متغيرات البيئة المطلوبة
- اختبار الاتصال بقاعدة البيانات
- التحقق من وجود مستخدم admin وإنشاؤه إذا لزم الأمر
- اختبار عمل JWT
- عرض تقرير شامل عن حالة النظام

## 🔑 متغيرات البيئة المطلوبة

يجب إضافة هذه المتغيرات في **DigitalOcean App Platform**:

```bash
DATABASE_URL=[استخدم القيمة من ملف PRIVATE_ENV_VALUES.txt]
JWT_SECRET=82ec93a86232fee07dcee0e3669bb4191953cb42d6ea6847808431d92eda6a1f
NEXTAUTH_SECRET=3fba94fd1803f7e72aebf109e4dcb3039c2fb094d3d94b9301e94feec00374c5
NODE_ENV=production
```

> **⚠️ مهم:** استخدم القيم الفعلية من ملف `PRIVATE_ENV_VALUES.txt` الموجود في المشروع.

## 📝 خطوات الإصلاح على DigitalOcean

### الخطوة 1: إضافة متغيرات البيئة
1. اذهب إلى **DigitalOcean App Platform**
2. اختر تطبيق `sabq-ai-cms`
3. اذهب إلى **Settings** → **Environment Variables**
4. أضف المتغيرات المذكورة أعلاه

### الخطوة 2: إعادة النشر
1. في **Deployments** اضغط على **Create Deployment**
2. أو استخدم **Force Rebuild** إذا لم تكن هناك تغييرات جديدة

### الخطوة 3: التحقق من الحالة
1. انتظر حتى يكتمل النشر
2. اذهب إلى رابط التطبيق
3. جرب تسجيل الدخول باستخدام:
   - **البريد الإلكتروني:** `admin@sabq.org`
   - **كلمة المرور:** `admin123456`

### الخطوة 4: فحص السجلات (إذا استمرت المشاكل)
1. في **Runtime Logs** ابحث عن رسائل تبدأ بـ `[AUTH]`
2. تحقق من وجود أخطاء الاتصال بقاعدة البيانات
3. تأكد من عدم وجود رسائل خطأ حول `JWT_SECRET`

## 🔍 تشخيص المشاكل

### إذا كان الخطأ 503 (Service Unavailable):
- تحقق من `DATABASE_URL` في متغيرات البيئة
- تأكد من صحة رابط قاعدة البيانات
- تحقق من أن PlanetScale database نشط

### إذا كان الخطأ 500 (Internal Server Error):
- تحقق من `JWT_SECRET` في متغيرات البيئة
- تأكد من عدم استخدام القيمة الافتراضية
- راجع سجلات التطبيق للمزيد من التفاصيل

### إذا كان الخطأ 401 (Unauthorized):
- تأكد من وجود مستخدم admin في قاعدة البيانات
- تحقق من تشفير كلمة المرور
- جرب إعادة تعيين كلمة مرور admin

## 🧪 اختبار النظام محلياً

```bash
# تشغيل سكريبت الإصلاح
node scripts/fix-digitalocean-auth.js

# تشغيل الخادم المحلي
npm run dev

# اختبار تسجيل الدخول
curl -X POST http://localhost:3000/api/auth/login \
  -H "Content-Type: application/json" \
  -d '{"email":"admin@sabq.org","password":"admin123456"}'
```

## 📊 معلومات المستخدم الافتراضي

```json
{
  "id": "230a1f62-ad7c-453a-b7d3-4524be3c73d5",
  "email": "admin@sabq.org",
  "name": "علي عبده",
  "role": "admin",
  "isAdmin": true,
  "isVerified": true
}
```

## 🚨 نصائح مهمة

1. **لا تشارك متغيرات البيئة**: احتفظ بها آمنة
2. **راقب السجلات**: تحقق من سجلات التطبيق بانتظام
3. **اختبر محلياً أولاً**: تأكد من عمل كل شيء محلياً قبل النشر
4. **احتفظ بنسخة احتياطية**: من قاعدة البيانات قبل إجراء تغييرات كبيرة

## 📞 إذا استمرت المشاكل

1. تحقق من حالة PlanetScale database
2. راجع سجلات DigitalOcean للأخطاء التفصيلية
3. جرب إعادة إنشاء التطبيق من الصفر إذا لزم الأمر

---

**تاريخ آخر تحديث:** يناير 2025  
**الحالة:** ✅ جاهز للتطبيق 