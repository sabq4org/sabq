# تقرير: حل مشكلة عدم ظهور المقالات في الأقسام

## التاريخ: 2025-07-15

## وصف المشكلة
المستخدم أبلغ عن أن آخر خبر منشور في تصنيف "سياحة":
- ✅ يظهر في الواجهة الرئيسية
- ❌ اختفى من قسم السياحة
- ❌ اختفى من صفحة جميع الأخبار

## السبب الجذري
بعد التحقيق، تبين أن المشكلة في **نظام التخزين المؤقت (Redis Cache)**:

1. **كاش مختلف لكل صفحة**: كل صفحة تستخدم مفتاح كاش مختلف
   - الصفحة الرئيسية: `articles:{}`
   - قسم السياحة: `articles:{"category_id":"cat-006"}`
   - جميع الأخبار: `articles:{"status":"published"}`

2. **مدة الكاش الطويلة**: 30 دقيقة للمقالات (CACHE_TTL.ARTICLES)

3. **عدم مسح الكاش تلقائياً**: عند نشر مقال جديد، لا يتم مسح الكاش القديم

## الحلول المطبقة

### 1. إنشاء API لإدارة الكاش
**الملف**: `app/api/cache/clear/route.ts`

يوفر:
- مسح كامل للكاش
- مسح كاش تصنيف معين
- مسح كاش مقال معين
- عرض حالة Redis

### 2. مسح تلقائي للكاش عند النشر/التحديث
**الملفات المحدثة**:
- `app/api/articles/route.ts` - مسح الكاش عند إنشاء مقال منشور
- `app/api/articles/[id]/route.ts` - مسح الكاش عند تحديث مقال

```typescript
// مسح الكاش عند إنشاء مقال جديد
if (status === 'published') {
  await cache.clearPattern('articles:*');
  if (category_id) {
    await cache.clearPattern(`articles:*category_id*${category_id}*`);
  }
}
```

### 3. واجهة إدارة الكاش في لوحة التحكم
**الملف الجديد**: `app/dashboard/cache-management/page.tsx`

توفر:
- عرض حالة Redis
- مسح جميع الكاش بنقرة واحدة
- مسح كاش المقالات فقط
- معلومات مفيدة عن الكاش

### 4. سكريبت تشخيص المشكلة
**الملف الجديد**: `scripts/fix-article-visibility.js`

يقوم بـ:
- تشخيص حالة الكاش
- فحص آخر المقالات المنشورة
- التحقق من ظهورها في أقسامها
- خيار مسح الكاش مباشرة

## كيفية الاستخدام

### حل فوري للمشكلة:
```bash
# تشغيل سكريبت التشخيص
node scripts/fix-article-visibility.js

# أو استخدام واجهة لوحة التحكم
http://localhost:3000/dashboard/cache-management
```

### للمطورين - مسح الكاش برمجياً:
```javascript
// مسح جميع الكاش
await fetch('/api/cache/clear', {
  method: 'POST',
  headers: { 'Content-Type': 'application/json' },
  body: JSON.stringify({ type: 'all' })
});

// مسح كاش تصنيف معين
await fetch('/api/cache/clear', {
  method: 'POST',
  headers: { 'Content-Type': 'application/json' },
  body: JSON.stringify({ 
    type: 'category',
    categoryId: 'cat-006' 
  })
});
```

## النتائج
- ✅ المقالات الجديدة تظهر فوراً في جميع الأقسام
- ✅ مسح الكاش تلقائي عند النشر/التحديث
- ✅ واجهة سهلة لإدارة الكاش يدوياً
- ✅ أداة تشخيص للمشاكل المستقبلية

## التوصيات المستقبلية

1. **تقليل مدة الكاش**: خفض مدة كاش المقالات من 30 إلى 5-10 دقائق
2. **استخدام Cache Tags**: لمسح انتقائي أفضل
3. **إشعارات الكاش**: إضافة إشعارات عند مسح الكاش
4. **مراقبة الكاش**: إضافة مؤشرات أداء لمراقبة فعالية الكاش

## معلومات تقنية إضافية

### مفاتيح الكاش المستخدمة:
```typescript
CACHE_KEYS = {
  articles: (params) => `articles:${JSON.stringify(params || {})}`,
  article: (id) => `article:${id}`,
  categories: () => 'categories:all',
  category: (id) => `category:${id}`
}
```

### أوقات التخزين المؤقت:
```typescript
CACHE_TTL = {
  ARTICLES: 60 * 30,      // 30 دقيقة
  CATEGORIES: 60 * 60 * 24, // 24 ساعة
  STATS: 60 * 5,          // 5 دقائق
  DEFAULT: 60 * 10        // 10 دقائق
}
```

## الخلاصة
تم حل المشكلة بنجاح من خلال:
1. تحديد السبب الجذري (الكاش القديم)
2. إضافة آليات مسح تلقائية ويدوية
3. توفير أدوات تشخيص وإدارة
4. توثيق الحل للمرجعية المستقبلية 