# تقرير ميزة "استمع للموجز" - صحيفة سبق

**التاريخ**: 2024-01-20  
**المطور**: مساعد AI  
**النطاق**: إضافة ميزة تحويل موجز المقالات إلى صوت

## ملخص التنفيذ

تم تنفيذ ميزة "استمع للموجز" التي تتيح للقراء الاستماع إلى موجز المقال بدلاً من قراءته. الميزة تستخدم ElevenLabs لتحويل النص إلى صوت باللغة العربية بجودة احترافية.

## المكونات المنفذة

### 1. API توليد الصوت (`/api/voice-summary/route.ts`)
- يستقبل معرف المقال
- يتحقق من وجود صوت مخزن مسبقاً (caching)
- يولد صوت جديد من موجز المقال إذا لم يكن موجوداً
- يحفظ رابط الصوت في قاعدة البيانات
- يدعم حذف الصوت المخزن مؤقتاً

### 2. مكون AudioSummaryPlayer (`/components/AudioSummaryPlayer.tsx`)
- واجهة مستخدم احترافية لمشغل الصوت
- زر "توليد الصوت من الموجز" عند الطلب
- مشغل صوت مع أزرار التحكم وشريط التقدم
- عرض نص الموجز أسفل المشغل
- دعم تحميل الملف الصوتي
- دعم الوضع الليلي

### 3. تحديث قاعدة البيانات
- إضافة حقل `audio_summary_url` إلى جدول `articles`
- تم تشغيل `prisma db push` لتحديث قاعدة البيانات

### 4. تكامل مع صفحة المقال
- إضافة المكون إلى صفحة المقال (`/article/[id]/page.tsx`)
- يظهر بعد ملخص AI وقبل شريط التفاعل
- يستخدم `excerpt` أو `summary` أو `ai_summary` كمصدر للنص

### 5. توليد تلقائي عند النشر
- تحديث API المقالات لتوليد الصوت تلقائياً
- يعمل فقط للمقالات المنشورة التي لها موجز
- لا يؤثر على نجاح عملية النشر إذا فشل توليد الصوت

## التقنيات المستخدمة

### Frontend
- React مع TypeScript
- Tailwind CSS للتصميم
- Lucide React للأيقونات
- HTML5 Audio API

### Backend
- Next.js API Routes
- Prisma ORM
- ElevenLabs API
- نظام caching ذكي

## مميزات النظام

### 1. التحميل عند الطلب (On-Demand)
- لا يتم توليد الصوت إلا عند طلب المستخدم
- يوفر في التكلفة والموارد

### 2. نظام Caching
- حفظ الصوت مرة واحدة فقط
- استرجاع سريع للملفات المحفوظة

### 3. معالجة الأخطاء
- رسائل خطأ واضحة للمستخدم
- fallback في حالة فشل أي خطوة

### 4. التصميم المتجاوب
- يعمل على جميع الأحجام
- دعم كامل للوضع الليلي

## إعدادات البيئة المطلوبة

```env
# مفتاح ElevenLabs API
ELEVENLABS_API_KEY=your-api-key-here

# (اختياري) لرفع الملفات لخادم خارجي
SITE_UPLOAD_ENDPOINT=https://your-server.com/upload
```

## استخدام الميزة

### للمستخدم النهائي:
1. فتح أي مقال يحتوي على موجز
2. النقر على "توليد الصوت من الموجز"
3. الانتظار حتى يتم التوليد (3-5 ثواني)
4. التحكم في التشغيل أو تحميل الملف

### للمحرر/الكاتب:
- كتابة موجز جيد للمقال في حقل excerpt
- نشر المقال (سيتم توليد الصوت تلقائياً إذا كانت الإعدادات مفعلة)

## التكلفة المتوقعة

- **ElevenLabs**: حوالي $0.18 لكل 1000 حرف
- **موجز نموذجي**: 200-500 حرف
- **تكلفة لكل موجز**: $0.04 - $0.09
- **توفير**: استخدام caching يقلل التكلفة بنسبة 100% للزيارات المتكررة

## التحسينات المستقبلية المقترحة

1. **أصوات متعددة**: السماح باختيار أصوات مختلفة
2. **سرعة التشغيل**: التحكم في سرعة التشغيل (0.5x - 2x)
3. **قائمة تشغيل**: جمع عدة موجزات في قائمة واحدة
4. **تحليلات**: تتبع عدد مرات الاستماع
5. **تكامل مع المساعد الصوتي**: Alexa, Google Assistant
6. **دعم لغات أخرى**: الإنجليزية وغيرها

## ملاحظات أمنية

- التحقق من صلاحيات المستخدم قبل توليد الصوت
- تقييد عدد الطلبات لمنع إساءة الاستخدام
- عدم تخزين بيانات حساسة في الملفات الصوتية

## الخلاصة

تم تنفيذ ميزة "استمع للموجز" بنجاح مع جميع المتطلبات المطلوبة. النظام يعمل بكفاءة ويوفر تجربة مستخدم ممتازة مع الحفاظ على التكلفة في حدود معقولة. 