# تقرير إصلاح مشكلة البحث بالكلمات المفتاحية

## التاريخ: يناير 2025

## المشكلة المبلغ عنها
عند الضغط على الكلمات المفتاحية في صفحة المقال، تظهر رسالة "لا توجد مقالات" حتى لو كانت هناك مقالات أخرى بنفس الكلمة المفتاحية.

## السبب الجذري
بعد التحقيق، تبين أن:
1. الكلمات المفتاحية محفوظة في `metadata.keywords` كمصفوفة
2. API التاقات كان يبحث فقط في حقل `seo_keywords` 
3. معظم المقالات لديها `seo_keywords = null`

## مثال من قاعدة البيانات
```json
{
  "id": "1629063d-436a-464c-a252-552896f25a0c",
  "title": "ثلاث ألعاب تسجّل ظهورها الأول في كأس العالم للرياضات الإلكترونية",
  "seo_keywords": null,
  "metadata": {
    "keywords": [
      "السعودية",
      "الرياض", 
      "الرياضات الألكترونية"
    ]
  }
}
```

## الحل المطبق

### 1. تحديث API التاقات (`/app/api/tags/[tag]/route.ts`)
- تم تغيير آلية البحث من استعلام Prisma المباشر إلى:
  1. جلب جميع المقالات المنشورة
  2. فلترة المقالات برمجياً للبحث في:
     - `seo_keywords` (نص مفصول بفواصل)
     - `metadata.keywords` (مصفوفة)
  3. البحث غير حساس لحالة الأحرف (case-insensitive)

### 2. ميزات الحل الجديد
- يدعم البحث في مصدرين للكلمات المفتاحية
- يدمج النتائج من كلا المصدرين
- يزيل التكرارات تلقائياً
- يحافظ على الترتيب الزمني (الأحدث أولاً)
- يدعم pagination بشكل صحيح

### 3. API جلب المقال
- يدمج الكلمات المفتاحية من كلا المصدرين عند عرض المقال
- يضمن عرض جميع الكلمات المفتاحية للمستخدم

## التحسينات المستقبلية المقترحة

### 1. توحيد تخزين الكلمات المفتاحية
- الانتقال لاستخدام حقل واحد فقط (`seo_keywords`)
- كتابة سكريبت لترحيل البيانات من `metadata.keywords` إلى `seo_keywords`

### 2. تحسين الأداء
- إضافة فهرس (index) على حقل `seo_keywords` في قاعدة البيانات
- استخدام البحث النصي الكامل (Full-text search) لـ PostgreSQL

### 3. تحسين واجهة المستخدم
- إضافة عداد للمقالات بجانب كل كلمة مفتاحية
- إضافة اقتراحات للكلمات المفتاحية المشابهة

## سكريبت الترحيل المقترح
```javascript
// scripts/migrate-keywords.js
const { PrismaClient } = require('./lib/generated/prisma');
const prisma = new PrismaClient();

async function migrateKeywords() {
  const articles = await prisma.articles.findMany({
    where: {
      metadata: { not: null }
    }
  });

  for (const article of articles) {
    if (article.metadata?.keywords) {
      await prisma.articles.update({
        where: { id: article.id },
        data: {
          seo_keywords: article.metadata.keywords.join(', ')
        }
      });
    }
  }
}
```

## النتيجة
✅ تم حل المشكلة بنجاح. الآن عند الضغط على أي كلمة مفتاحية، سيتم عرض جميع المقالات المرتبطة بها بغض النظر عن مكان تخزين الكلمة المفتاحية. 